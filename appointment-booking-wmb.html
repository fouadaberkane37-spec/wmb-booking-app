<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Services Booking - Groupe WMB</title>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --cream: #faf8f3;
            --charcoal: #2a2a2a;
            --sage: #6b8cb3;
            --terracotta: #5c7ad6;
            --soft-grey: #e8e4dc;
            --deep-green: #4a5f7b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Crimson Pro', serif;
            background: linear-gradient(135deg, var(--cream) 0%, #f5f1e8 100%);
            color: var(--charcoal);
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 2px;
            box-shadow: 
                0 1px 3px rgba(0,0,0,0.05),
                0 20px 60px rgba(0,0,0,0.08);
            overflow: visible;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header {
            background: var(--charcoal);
            color: var(--cream);
            padding: 3rem 3rem 2.5rem;
            position: relative;
            overflow: visible;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(107,140,179,0.15) 0%, transparent 70%);
            border-radius: 50%;
        }

        .header-content {
            position: relative;
        }

        h1 {
            font-size: 3rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .subtitle {
            font-family: 'DM Mono', monospace;
            font-size: 0.875rem;
            opacity: 0.7;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .menu-container {
            position: relative;
            z-index: 9999;
        }

        .hamburger-btn {
            background: transparent;
            border: 2px solid var(--cream);
            width: 50px;
            height: 50px;
            border-radius: 2px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            padding: 0;
            transition: all 0.3s;
            position: relative;
            z-index: 9999;
        }

        .hamburger-btn:hover {
            background: var(--cream);
        }

        .hamburger-btn span {
            width: 24px;
            height: 2px;
            background: var(--cream);
            transition: all 0.3s;
            display: block;
        }

        .hamburger-btn:hover span {
            background: var(--charcoal);
        }

        .dropdown-menu {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border-radius: 2px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-width: 220px;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 9999;
        }

        .dropdown-menu.show {
            opacity: 1;
            pointer-events: all;
            transform: translateY(0);
        }

        .dropdown-menu a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: var(--charcoal);
            text-decoration: none;
            font-family: 'DM Mono', monospace;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            border-bottom: 1px solid var(--soft-grey);
            transition: all 0.2s;
        }

        .dropdown-menu a:last-child {
            border-bottom: none;
        }

        .dropdown-menu a:hover {
            background: rgba(107,140,179,0.1);
            padding-left: 2rem;
        }

        .dropdown-menu a.active {
            background: var(--sage);
            color: white;
        }

        .menu-icon {
            font-size: 1.25rem;
        }

        .booking-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }

        .calendar-section, .details-section {
            padding: 3rem;
        }

        .calendar-section {
            border-right: 1px solid var(--soft-grey);
            background: linear-gradient(to bottom, #fafafa 0%, white 100%);
        }

        .section-title {
            font-family: 'DM Mono', monospace;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--sage);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .duration-selector {
            margin-bottom: 2rem;
        }

        .duration-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .duration-option {
            padding: 1rem;
            border: 2px solid var(--soft-grey);
            background: white;
            border-radius: 2px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .duration-option:hover {
            border-color: var(--sage);
            background: rgba(122,155,118,0.05);
        }

        .duration-option.selected {
            background: var(--deep-green);
            border-color: var(--deep-green);
            color: white;
        }

        .duration-title {
            font-family: 'DM Mono', monospace;
            font-size: 1.5rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .duration-label {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .month-display {
            font-size: 1.5rem;
            font-weight: 400;
        }

        .nav-buttons button {
            background: none;
            border: 1px solid var(--soft-grey);
            color: var(--charcoal);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .nav-buttons button:hover {
            background: var(--sage);
            border-color: var(--sage);
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day-label {
            font-family: 'DM Mono', monospace;
            font-size: 0.7rem;
            text-align: center;
            padding: 0.5rem;
            color: var(--sage);
            font-weight: 500;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            font-size: 0.95rem;
        }

        .calendar-day:not(.disabled):not(.empty):hover {
            background: var(--sage);
            color: white;
            transform: scale(1.05);
        }

        .calendar-day.selected {
            background: var(--terracotta);
            color: white;
            font-weight: 600;
        }

        .calendar-day.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .calendar-day.limited {
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 2px,
                rgba(92,122,214,0.1) 2px,
                rgba(92,122,214,0.1) 4px
            );
        }

        .calendar-day.empty {
            cursor: default;
        }

        .time-slots {
            margin-top: 2rem;
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .time-grid::-webkit-scrollbar {
            width: 6px;
        }

        .time-grid::-webkit-scrollbar-track {
            background: var(--soft-grey);
            border-radius: 3px;
        }

        .time-grid::-webkit-scrollbar-thumb {
            background: var(--sage);
            border-radius: 3px;
        }

        .time-slot {
            padding: 0.875rem;
            border: 1px solid var(--soft-grey);
            background: white;
            border-radius: 2px;
            cursor: pointer;
            text-align: center;
            font-family: 'DM Mono', monospace;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .time-slot:hover:not(.unavailable) {
            border-color: var(--sage);
            background: rgba(107,140,179,0.05);
        }

        .time-slot.selected {
            background: var(--deep-green);
            border-color: var(--deep-green);
            color: white;
        }

        .time-slot.unavailable {
            opacity: 0.3;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        .time-range {
            font-weight: 500;
        }

        .time-end {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .availability-warning {
            background: rgba(92,122,214,0.1);
            border-left: 3px solid var(--terracotta);
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 2px;
            font-size: 0.875rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-family: 'DM Mono', monospace;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            color: var(--sage);
        }

        input, textarea, select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid var(--soft-grey);
            border-radius: 2px;
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(107,140,179,0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .service-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            background: #fafafa;
            border-radius: 2px;
            border: 1px solid var(--soft-grey);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 2px;
            transition: background 0.2s;
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            text-transform: none;
            color: var(--charcoal);
            letter-spacing: normal;
        }

        .checkbox-label:hover {
            background: rgba(107,140,179,0.05);
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin-right: 0.75rem;
            cursor: pointer;
            accent-color: var(--sage);
        }

        .checkbox-label span {
            flex: 1;
        }

        .error-message {
            color: var(--terracotta);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            font-family: 'DM Mono', monospace;
        }

        .edit-salespeople-btn {
            margin-top: 0.5rem;
            padding: 0.625rem 1rem;
            background: transparent;
            color: var(--sage);
            border: 1px solid var(--sage);
            border-radius: 2px;
            font-family: 'DM Mono', monospace;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            display: block;
            width: 100%;
        }

        .edit-salespeople-btn:hover {
            background: var(--sage);
            color: white;
        }

        .modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal.show {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 2px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.2);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 400;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--charcoal);
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--terracotta);
        }

        .salespeople-list {
            margin-bottom: 1.5rem;
        }

        .salesperson-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border: 1px solid var(--soft-grey);
            border-radius: 2px;
            margin-bottom: 0.5rem;
            background: #fafafa;
        }

        .salesperson-item span {
            flex: 1;
        }

        .delete-btn {
            background: none;
            border: none;
            color: var(--terracotta);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0 0.5rem;
            transition: transform 0.2s;
        }

        .delete-btn:hover {
            transform: scale(1.2);
        }

        .add-salesperson-form {
            display: flex;
            gap: 0.5rem;
        }

        .add-salesperson-form input {
            flex: 1;
        }

        .add-btn {
            padding: 0.875rem 1.5rem;
            background: var(--deep-green);
            color: white;
            border: none;
            border-radius: 2px;
            font-family: 'DM Mono', monospace;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .add-btn:hover {
            background: var(--sage);
        }

        .submit-button {
            width: 100%;
            padding: 1.125rem;
            background: var(--terracotta);
            color: white;
            border: none;
            border-radius: 2px;
            font-family: 'DM Mono', monospace;
            font-size: 0.875rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            margin-top: 2rem;
        }

        .submit-button:hover:not(:disabled) {
            background: var(--deep-green);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(74,95,123,0.3);
        }

        .submit-button:active {
            transform: translateY(0);
        }

        .submit-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .booking-summary {
            background: linear-gradient(135deg, var(--sage) 0%, var(--deep-green) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 2px;
            margin-bottom: 1rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .booking-summary.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .booking-summary h3 {
            font-size: 1rem;
            font-family: 'DM Mono', monospace;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .booking-summary p {
            margin: 0.5rem 0;
            opacity: 0.95;
        }

        .capacity-info {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.2);
            font-size: 0.875rem;
        }

        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            padding: 3rem;
            border-radius: 2px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.2);
            text-align: center;
            max-width: 500px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 1000;
        }

        .success-message.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: all;
        }

        .success-message h2 {
            color: var(--deep-green);
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .success-message p {
            margin: 0.5rem 0;
            color: var(--charcoal);
        }

        .close-button {
            margin-top: 2rem;
            padding: 0.875rem 2rem;
            background: var(--terracotta);
            color: white;
            border: none;
            border-radius: 2px;
            font-family: 'DM Mono', monospace;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .close-button:hover {
            background: var(--deep-green);
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 999;
        }

        .overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        @media (max-width: 768px) {
            .booking-grid {
                grid-template-columns: 1fr;
            }

            .calendar-section {
                border-right: none;
                border-bottom: 1px solid var(--soft-grey);
            }

            .time-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2rem;
            }

            .duration-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>Home Services Booking</h1>
                <p class="subtitle">Groupe WMB</p>
            </div>
            <div class="menu-container">
                <button class="hamburger-btn" id="hamburgerBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="dropdown-menu" id="dropdownMenu">
                    <a href="appointment-booking-wmb.html" class="active">
                        <span class="menu-icon">üìÖ</span>
                        New Booking
                    </a>
                    <a href="appointments-calendar.html">
                        <span class="menu-icon">üìÜ</span>
                        View Calendar
                    </a>
                    <a href="#" id="logoutBtn">
                        <span class="menu-icon">üö™</span>
                        Logout
                    </a>
                </div>
            </div>
        </header>

        <div class="booking-grid">
            <div class="calendar-section">
                <div class="duration-selector">
                    <p class="section-title">Select Duration</p>
                    <div class="duration-options">
                        <div class="duration-option" data-duration="60">
                            <div class="duration-title">60</div>
                            <div class="duration-label">minutes</div>
                        </div>
                        <div class="duration-option" data-duration="120">
                            <div class="duration-title">120</div>
                            <div class="duration-label">minutes</div>
                        </div>
                        <div class="duration-option" data-duration="180">
                            <div class="duration-title">180</div>
                            <div class="duration-label">minutes</div>
                        </div>
                    </div>
                </div>

                <p class="section-title">Choose a Date</p>
                
                <div class="calendar-header">
                    <div class="month-display" id="monthDisplay"></div>
                    <div class="nav-buttons">
                        <button id="prevMonth">‚Üê</button>
                        <button id="nextMonth">‚Üí</button>
                    </div>
                </div>

                <div class="calendar-grid" id="calendarGrid"></div>

                <div class="time-slots" id="timeSlotSection" style="display: none;">
                    <p class="section-title">Available Times</p>
                    <div id="availabilityWarning"></div>
                    <div class="time-grid" id="timeGrid"></div>
                </div>
            </div>

            <div class="details-section">
                <p class="section-title">Salesperson</p>

                <div class="form-group">
                    <label for="salesperson">Assigned To</label>
                    <select id="salesperson" required>
                        <option value="">Select salesperson</option>
                        <option value="John Smith">John Smith</option>
                        <option value="Sarah Johnson">Sarah Johnson</option>
                        <option value="Michael Brown">Michael Brown</option>
                        <option value="Emily Davis">Emily Davis</option>
                    </select>
                    <button type="button" class="edit-salespeople-btn" id="editSalespeople">
                        ‚úé Edit Salespeople
                    </button>
                </div>

                <div class="booking-summary" id="bookingSummary">
                    <h3>Booking Details</h3>
                    <p><strong>Duration:</strong> <span id="summaryDuration">Not selected</span></p>
                    <p><strong>Date:</strong> <span id="summaryDate">Not selected</span></p>
                    <p><strong>Time:</strong> <span id="summaryTime">Not selected</span></p>
                    <div class="capacity-info" id="capacityInfo"></div>
                </div>

                <form id="bookingForm">
                    <div class="form-group">
                        <label for="name">Full Name</label>
                        <input type="text" id="name" required placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" required placeholder="john@example.com">
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" required placeholder="+1 (555) 123-4567">
                    </div>

                    <div class="form-group">
                        <label>Service Type (Select all that apply)</label>
                        <div class="service-checkboxes" id="serviceCheckboxes">
                            <label class="checkbox-label">
                                <input type="checkbox" name="service" value="window-exterior">
                                <span>Window cleaning - exterior</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="service" value="window-interior">
                                <span>Window cleaning - interior</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="service" value="gutter-interior">
                                <span>Gutter cleaning - interior</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="service" value="gutter-exterior">
                                <span>Gutter cleaning - exterior</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" name="service" value="soft-wash">
                                <span>Soft wash</span>
                            </label>
                        </div>
                        <div class="error-message" id="serviceError" style="display: none;">
                            Please select at least one service
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="address">Service Address</label>
                        <input type="text" id="address" required placeholder="123 Main St, City, State">
                    </div>

                    <div class="form-group">
                        <label for="notes">Additional Notes (Optional)</label>
                        <textarea id="notes" placeholder="Any specific details about the service needed?"></textarea>
                    </div>

                    <button type="submit" class="submit-button" id="submitButton" disabled>
                        Confirm Booking
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    
    <div class="success-message" id="successMessage">
        <h2>‚úì Booking Confirmed!</h2>
        <p><strong>Duration:</strong> <span id="confirmDuration"></span></p>
        <p><strong>Date:</strong> <span id="confirmDate"></span></p>
        <p><strong>Time:</strong> <span id="confirmTime"></span></p>
        <p><strong>Service:</strong> <span id="confirmService"></span></p>
        <p style="margin-top: 1.5rem; opacity: 0.8;">A confirmation email has been sent to your inbox.</p>
        <button class="close-button" id="closeButton">Close</button>
    </div>

    <div class="modal" id="salespeopleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Salespeople</h2>
                <button class="modal-close" id="closeModal">√ó</button>
            </div>
            
            <div class="salespeople-list" id="salespeopleList">
                <!-- Dynamically populated -->
            </div>

            <div class="add-salesperson-form">
                <input type="text" id="newSalespersonName" placeholder="Enter salesperson name">
                <button class="add-btn" id="addSalesperson">Add</button>
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        const loggedIn = localStorage.getItem('wmb_logged_in') || sessionStorage.getItem('wmb_logged_in');
        if (loggedIn !== 'true') {
            window.location.href = 'login.html';
        }

        const BUFFER_TIME = 30; // minutes
        const DAILY_LIMIT = 480; // minutes per day
        const WEEKLY_LIMIT = 2400; // minutes per week
        const WORK_START = 7; // 7 AM
        const WORK_END = 18; // 6 PM

        const state = {
            currentDate: new Date(),
            selectedDate: null,
            selectedTime: null,
            selectedDuration: null,
            bookings: {}, // Format: { 'YYYY-MM-DD': [{start: '09:00', duration: 60}, ...] }
            salespeople: ['John Smith', 'Sarah Johnson', 'Michael Brown', 'Emily Davis'] // Editable list
        };

        // Demo bookings
        const today = new Date();
        const todayStr = formatDateKey(today);
        state.bookings[todayStr] = [
            { start: '09:00', duration: 120 },
            { start: '13:00', duration: 60 }
        ];

        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function formatDateDisplay(date) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function getDailyUsage(dateKey) {
            const bookings = state.bookings[dateKey] || [];
            return bookings.reduce((sum, booking) => sum + booking.duration, 0);
        }

        function getWeeklyUsage(date) {
            const weekStart = getWeekStart(date);
            let total = 0;
            
            for (let i = 0; i < 7; i++) {
                const d = new Date(weekStart);
                d.setDate(weekStart.getDate() + i);
                const key = formatDateKey(d);
                total += getDailyUsage(key);
            }
            
            return total;
        }

        function canBookOnDay(date, duration) {
            const dateKey = formatDateKey(date);
            const dailyUsed = getDailyUsage(dateKey);
            const weeklyUsed = getWeeklyUsage(date);
            
            return dailyUsed + duration <= DAILY_LIMIT && 
                   weeklyUsed + duration <= WEEKLY_LIMIT;
        }

        function isTimeSlotAvailable(dateKey, startTime, duration) {
            const bookings = state.bookings[dateKey] || [];
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = startMinutes + duration;

            // Check work hours
            const workEndMinutes = WORK_END * 60;
            if (endMinutes > workEndMinutes) {
                return false;
            }

            // Check conflicts with existing bookings (including buffer)
            for (const booking of bookings) {
                const bookingStart = timeToMinutes(booking.start);
                const bookingEnd = bookingStart + booking.duration;
                
                // Add buffer time
                const bufferedBookingStart = bookingStart - BUFFER_TIME;
                const bufferedBookingEnd = bookingEnd + BUFFER_TIME;
                
                // Check if time slots overlap
                if (startMinutes < bufferedBookingEnd && endMinutes > bufferedBookingStart) {
                    return false;
                }
            }

            return true;
        }

        function generateTimeSlots() {
            const slots = [];
            const startMinutes = WORK_START * 60;
            const endMinutes = WORK_END * 60;
            
            for (let minutes = startMinutes; minutes < endMinutes; minutes += 30) {
                slots.push(minutesToTime(minutes));
            }
            
            return slots;
        }

        function renderCalendar() {
            const year = state.currentDate.getFullYear();
            const month = state.currentDate.getMonth();
            
            document.getElementById('monthDisplay').textContent = 
                state.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Day labels
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                const label = document.createElement('div');
                label.className = 'calendar-day-label';
                label.textContent = day;
                grid.appendChild(label);
            });

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }

            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;

                const date = new Date(year, month, day);
                date.setHours(0, 0, 0, 0);

                if (date < today) {
                    dayElement.classList.add('disabled');
                } else {
                    const dateKey = formatDateKey(date);
                    const dailyUsed = getDailyUsage(dateKey);
                    
                    if (state.selectedDuration && !canBookOnDay(date, state.selectedDuration)) {
                        dayElement.classList.add('limited');
                        dayElement.title = 'Limited availability';
                    }

                    if (state.selectedDate && 
                        state.selectedDate.getDate() === day &&
                        state.selectedDate.getMonth() === month &&
                        state.selectedDate.getFullYear() === year) {
                        dayElement.classList.add('selected');
                    }

                    dayElement.addEventListener('click', () => {
                        state.selectedDate = date;
                        state.selectedTime = null;
                        renderCalendar();
                        renderTimeSlots();
                        updateBookingSummary();
                    });
                }

                grid.appendChild(dayElement);
            }
        }

        function renderTimeSlots() {
            const section = document.getElementById('timeSlotSection');
            const grid = document.getElementById('timeGrid');
            const warningDiv = document.getElementById('availabilityWarning');
            
            if (!state.selectedDate || !state.selectedDuration) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            grid.innerHTML = '';
            warningDiv.innerHTML = '';

            const dateKey = formatDateKey(state.selectedDate);
            const dailyUsed = getDailyUsage(dateKey);
            const dailyRemaining = DAILY_LIMIT - dailyUsed;
            
            if (dailyRemaining < state.selectedDuration) {
                warningDiv.innerHTML = `
                    <div class="availability-warning">
                        ‚ö†Ô∏è Only ${dailyRemaining} minutes available today. Please select a different date or shorter duration.
                    </div>
                `;
            }

            const slots = generateTimeSlots();

            slots.forEach(time => {
                const startMinutes = timeToMinutes(time);
                const endMinutes = startMinutes + state.selectedDuration;
                
                // Skip if end time goes past work hours
                if (endMinutes > WORK_END * 60) {
                    return;
                }

                const slot = document.createElement('div');
                slot.className = 'time-slot';
                
                const endTime = minutesToTime(endMinutes);
                slot.innerHTML = `
                    <div class="time-range">${time} - ${endTime}</div>
                    <div class="time-end">${state.selectedDuration} minutes</div>
                `;

                const available = isTimeSlotAvailable(dateKey, time, state.selectedDuration);
                
                if (!available) {
                    slot.classList.add('unavailable');
                } else {
                    if (state.selectedTime === time) {
                        slot.classList.add('selected');
                    }

                    slot.addEventListener('click', () => {
                        state.selectedTime = time;
                        renderTimeSlots();
                        updateBookingSummary();
                    });
                }

                grid.appendChild(slot);
            });
        }

        function updateBookingSummary() {
            const summary = document.getElementById('bookingSummary');
            const durationSpan = document.getElementById('summaryDuration');
            const dateSpan = document.getElementById('summaryDate');
            const timeSpan = document.getElementById('summaryTime');
            const capacityDiv = document.getElementById('capacityInfo');
            const submitButton = document.getElementById('submitButton');

            if (state.selectedDuration) {
                durationSpan.textContent = `${state.selectedDuration} minutes`;
            } else {
                durationSpan.textContent = 'Not selected';
            }

            if (state.selectedDate && state.selectedTime && state.selectedDuration) {
                summary.classList.add('visible');
                dateSpan.textContent = formatDateDisplay(state.selectedDate);
                const endTime = minutesToTime(timeToMinutes(state.selectedTime) + state.selectedDuration);
                timeSpan.textContent = `${state.selectedTime} - ${endTime}`;
                submitButton.disabled = false;

                const dateKey = formatDateKey(state.selectedDate);
                const dailyUsed = getDailyUsage(dateKey);
                const weeklyUsed = getWeeklyUsage(state.selectedDate);
                
                capacityDiv.innerHTML = `
                    <strong>Daily capacity:</strong> ${dailyUsed + state.selectedDuration}/${DAILY_LIMIT} min<br>
                    <strong>Weekly capacity:</strong> ${weeklyUsed + state.selectedDuration}/${WEEKLY_LIMIT} min
                `;
            } else {
                if (!state.selectedDuration || !state.selectedDate || !state.selectedTime) {
                    summary.classList.remove('visible');
                }
                dateSpan.textContent = 'Not selected';
                timeSpan.textContent = 'Not selected';
                submitButton.disabled = true;
                capacityDiv.innerHTML = '';
            }
        }

        // Duration selection
        document.querySelectorAll('.duration-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                state.selectedDuration = parseInt(option.dataset.duration);
                state.selectedTime = null;
                renderCalendar();
                renderTimeSlots();
                updateBookingSummary();
            });
        });

        document.getElementById('prevMonth').addEventListener('click', () => {
            state.currentDate.setMonth(state.currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            state.currentDate.setMonth(state.currentDate.getMonth() + 1);
            renderCalendar();
        });

        document.getElementById('bookingForm').addEventListener('submit', (e) => {
            e.preventDefault();

            // Get selected services
            const selectedServices = Array.from(document.querySelectorAll('input[name="service"]:checked'))
                .map(cb => cb.nextElementSibling.textContent);

            // Validate at least one service is selected
            const serviceError = document.getElementById('serviceError');
            if (selectedServices.length === 0) {
                serviceError.style.display = 'block';
                return;
            } else {
                serviceError.style.display = 'none';
            }

            const formData = {
                salesperson: document.getElementById('salesperson').value,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                services: selectedServices,
                address: document.getElementById('address').value,
                notes: document.getElementById('notes').value,
                duration: state.selectedDuration,
                date: formatDateDisplay(state.selectedDate),
                time: state.selectedTime
            };

            // Add to bookings
            const dateKey = formatDateKey(state.selectedDate);
            if (!state.bookings[dateKey]) {
                state.bookings[dateKey] = [];
            }
            state.bookings[dateKey].push({
                start: state.selectedTime,
                duration: state.selectedDuration
            });

            // Show success message
            const endTime = minutesToTime(timeToMinutes(state.selectedTime) + state.selectedDuration);
            document.getElementById('confirmDuration').textContent = `${formData.duration} minutes`;
            document.getElementById('confirmDate').textContent = formData.date;
            document.getElementById('confirmTime').textContent = `${formData.time} - ${endTime}`;
            document.getElementById('confirmService').textContent = selectedServices.join(', ');
            
            document.getElementById('overlay').classList.add('show');
            document.getElementById('successMessage').classList.add('show');

            console.log('Booking submitted:', formData);
        });

        document.getElementById('closeButton').addEventListener('click', () => {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('successMessage').classList.remove('show');
            
            // Reset form
            document.getElementById('bookingForm').reset();
            document.querySelectorAll('.duration-option').forEach(o => o.classList.remove('selected'));
            document.querySelectorAll('input[name="service"]').forEach(cb => cb.checked = false);
            document.getElementById('serviceError').style.display = 'none';
            state.selectedDate = null;
            state.selectedTime = null;
            state.selectedDuration = null;
            renderCalendar();
            renderTimeSlots();
            updateBookingSummary();
        });

        document.getElementById('overlay').addEventListener('click', () => {
            document.getElementById('closeButton').click();
        });

        // Initialize
        renderCalendar();
        updateBookingSummary();

        // Salespeople Management
        function updateSalespeopleDropdown() {
            const select = document.getElementById('salesperson');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">Select salesperson</option>';
            state.salespeople.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });
            
            // Restore selection if still exists
            if (currentValue && state.salespeople.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function renderSalespeopleList() {
            const list = document.getElementById('salespeopleList');
            list.innerHTML = '';
            
            state.salespeople.forEach((person, index) => {
                const item = document.createElement('div');
                item.className = 'salesperson-item';
                item.innerHTML = `
                    <span>${person}</span>
                    <button class="delete-btn" data-index="${index}">√ó</button>
                `;
                list.appendChild(item);
            });

            // Add delete event listeners
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    state.salespeople.splice(index, 1);
                    renderSalespeopleList();
                    updateSalespeopleDropdown();
                });
            });
        }

        // Edit Salespeople Modal
        document.getElementById('editSalespeople').addEventListener('click', () => {
            renderSalespeopleList();
            document.getElementById('salespeopleModal').classList.add('show');
            document.getElementById('overlay').classList.add('show');
        });

        document.getElementById('closeModal').addEventListener('click', () => {
            document.getElementById('salespeopleModal').classList.remove('show');
            document.getElementById('overlay').classList.remove('show');
        });

        document.getElementById('addSalesperson').addEventListener('click', () => {
            const input = document.getElementById('newSalespersonName');
            const name = input.value.trim();
            
            if (name && !state.salespeople.includes(name)) {
                state.salespeople.push(name);
                renderSalespeopleList();
                updateSalespeopleDropdown();
                input.value = '';
            }
        });

        // Allow Enter key to add salesperson
        document.getElementById('newSalespersonName').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('addSalesperson').click();
            }
        });

        // Close modal when clicking overlay (but not when clicking success message overlay)
        document.getElementById('overlay').addEventListener('click', () => {
            if (document.getElementById('salespeopleModal').classList.contains('show')) {
                document.getElementById('closeModal').click();
            }
        });

        // Initialize dropdown
        updateSalespeopleDropdown();

        // Hamburger menu toggle
        document.getElementById('hamburgerBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('dropdownMenu').classList.toggle('show');
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('dropdownMenu');
            const btn = document.getElementById('hamburgerBtn');
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('show');
            }
        });

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('wmb_logged_in');
            localStorage.removeItem('wmb_user_email');
            sessionStorage.removeItem('wmb_logged_in');
            sessionStorage.removeItem('wmb_user_email');
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>